name: Deploy Container Images

on:
	push:
		branches:
			- main
	workflow_dispatch:

jobs:
	build-and-push:
		runs-on: ubuntu-latest
		permissions:
			contents: read
		env:
			REGISTRY: registry.digitalocean.com/${{ vars.DIGITALOCEAN_REGISTRY }}
		strategy:
			fail-fast: false
			matrix:
				service: [core, gateway, payment]
		steps:
			- name: Checkout repository
				uses: actions/checkout@v4

			- name: Set up QEMU
				uses: docker/setup-qemu-action@v3

			- name: Set up Docker Buildx
				uses: docker/setup-buildx-action@v3

			- name: Install doctl
				uses: digitalocean/action-doctl@v2
				with:
					token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

			- name: Authenticate to DigitalOcean Container Registry
				run: doctl registry login --expiry-seconds 600

			- name: Generate metadata for ${{ matrix.service }}
				id: meta
				uses: docker/metadata-action@v5
				with:
					images: ${{ env.REGISTRY }}/${{ matrix.service }}
					tags: |
						type=raw,value=latest
						type=sha,format=short

			- name: Build and push ${{ matrix.service }}
				uses: docker/build-push-action@v5
				with:
					context: .
					file: apps/${{ matrix.service }}/Dockerfile
					push: true
					platforms: linux/amd64
					tags: ${{ steps.meta.outputs.tags }}
					labels: ${{ steps.meta.outputs.labels }}

